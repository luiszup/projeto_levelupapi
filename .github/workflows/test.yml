name: Tests and Coverage
on:
  push:
    branches: [ main, master, test ]
  pull_request:
    branches: [ main, master, test ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests and Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
        
    - name: Grant execute permission for mvnw
      run: chmod +x mvnw
        
    - name: Run tests and generate coverage report
      run: |
        chmod +x mvnw
        ./mvnw clean verify
      
    - name: Display coverage in logs
      run: |
        JACOCO_REPORT="target/site/jacoco/jacoco.xml"
        if [ -f "$JACOCO_REPORT" ]; then
            echo "ğŸ“Š === RELATÃ“RIO DE COBERTURA ==="
            echo "ğŸŒ¿ Branch atual: ${{ github.ref_name }}"
            echo "ğŸ“ Arquivo encontrado: $JACOCO_REPORT"
            echo ""
            
            # Extrair dados usando sed de forma mais robusta
            INSTRUCTION_LINE=$(grep '<counter type="INSTRUCTION"' "$JACOCO_REPORT" | head -1)
            
            if [ ! -z "$INSTRUCTION_LINE" ]; then
                echo "ğŸ” Linha de instruÃ§Ãµes: $INSTRUCTION_LINE"
                
                # Extrair covered e missed usando sed
                COVERED=$(echo "$INSTRUCTION_LINE" | sed -n 's/.*covered="\([0-9]*\)".*/\1/p')
                MISSED=$(echo "$INSTRUCTION_LINE" | sed -n 's/.*missed="\([0-9]*\)".*/\1/p')
                
                echo "ğŸ”¢ Valores extraÃ­dos - Covered: '$COVERED', Missed: '$MISSED'"
                
                if [ ! -z "$COVERED" ] && [ ! -z "$MISSED" ] && [ "$COVERED" != "" ] && [ "$MISSED" != "" ]; then
                    TOTAL=$((COVERED + MISSED))
                    
                    if [ $TOTAL -gt 0 ]; then
                        COVERAGE=$((COVERED * 100 / TOTAL))
                        
                        echo "================================"
                        echo "âœ… InstruÃ§Ãµes cobertas: $COVERED"
                        echo "âŒ InstruÃ§Ãµes nÃ£o cobertas: $MISSED"
                        echo "ğŸ“Š Total de instruÃ§Ãµes: $TOTAL"
                        echo "ğŸ† Cobertura total: $COVERAGE%"
                        echo "================================"
                        
                        # Define o mÃ­nimo de cobertura (alinhado com pom.xml)
                        MIN_COVERAGE=65
                        
                        if [ $COVERAGE -lt $MIN_COVERAGE ]; then
                            echo "âŒ ERRO: Cobertura de testes ($COVERAGE%) abaixo do mÃ­nimo ($MIN_COVERAGE%)"
                            echo "ğŸ’¡ Adicione mais testes para melhorar a cobertura"
                            echo "ğŸ“ SugestÃµes:"
                            echo "   - Teste os controllers com @WebMvcTest"
                            echo "   - Teste os services com @MockBean"
                            echo "   - Teste as validaÃ§Ãµes e exceÃ§Ãµes"
                            echo "   - Teste cenÃ¡rios de sucesso e erro"
                            exit 1
                        else
                            echo "âœ… Cobertura de testes adequada! ğŸ‰"
                            echo "ğŸš€ Pronto para seguir com o desenvolvimento!"
                        fi
                    else
                        echo "âš ï¸ Total de instruÃ§Ãµes Ã© zero"
                        echo "ğŸ“„ ConteÃºdo do XML (primeiras 10 linhas):"
                        head -10 "$JACOCO_REPORT"
                    fi
                else
                    echo "âš ï¸ NÃ£o foi possÃ­vel extrair os valores numÃ©ricos"
                    echo "ğŸ“„ Tentando abordagem alternativa..."
                    
                    # Abordagem alternativa - contar linhas do XML
                    TOTAL_COUNTERS=$(grep -c '<counter type="INSTRUCTION"' "$JACOCO_REPORT")
                    echo "ğŸ“Š Total de contadores encontrados: $TOTAL_COUNTERS"
                    
                    if [ $TOTAL_COUNTERS -gt 0 ]; then
                        echo "âœ… RelatÃ³rio gerado com sucesso!"
                        echo "ğŸ“‹ Verifique o arquivo em: target/site/jacoco/index.html"
                    else
                        echo "âŒ Nenhum contador de instruÃ§Ãµes encontrado"
                        echo "ğŸ“„ Primeiras 20 linhas do arquivo:"
                        head -20 "$JACOCO_REPORT"
                    fi
                fi
            else
                echo "âŒ Linha de instruÃ§Ãµes nÃ£o encontrada no XML"
                echo "ğŸ“„ ConteÃºdo do arquivo (primeiras 20 linhas):"
                head -20 "$JACOCO_REPORT"
            fi
        else
            echo "âŒ RelatÃ³rio do JaCoCo nÃ£o encontrado em $JACOCO_REPORT"
            echo "ğŸ“ Verificando arquivos no diretÃ³rio target:"
            find target/ -name "*.xml" -type f 2>/dev/null | head -10 || echo "Nenhum arquivo XML encontrado"
            echo ""
            echo "ğŸ’¡ Certifique-se de que o plugin JaCoCo estÃ¡ configurado no pom.xml"
            exit 1
        fi
      
    - name: Upload coverage reports to Codecov
      if: github.event_name == 'push' || github.event_name == 'pull_request'
      uses: codecov/codecov-action@v3
      with:
        file: target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-levelup-api
        fail_ci_if_error: false
        
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = 'target/site/jacoco/jacoco.xml';
          
          if (fs.existsSync(path)) {
            const coverage = fs.readFileSync(path, 'utf8');
            const instructionMatch = coverage.match(/<counter type="INSTRUCTION"[^>]*covered="(\d+)"[^>]*missed="(\d+)"/);
            
            if (instructionMatch) {
              const covered = parseInt(instructionMatch[1]);
              const missed = parseInt(instructionMatch[2]);
              const total = covered + missed;
              const percentage = Math.round((covered * 100) / total);
              
              // Extrair tambÃ©m cobertura de branches se disponÃ­vel
              const branchMatch = coverage.match(/<counter type="BRANCH"[^>]*covered="(\d+)"[^>]*missed="(\d+)"/);
              let branchCoverage = "N/A";
              if (branchMatch) {
                const branchCovered = parseInt(branchMatch[1]);
                const branchMissed = parseInt(branchMatch[2]);
                const branchTotal = branchCovered + branchMissed;
                branchCoverage = branchTotal > 0 ? Math.round((branchCovered * 100) / branchTotal) + "%" : "N/A";
              }
              
              const emoji = percentage >= 70 ? 'âœ…' : 'âš ï¸';
              const status = percentage >= 70 ? 'Cobertura adequada!' : 'Cobertura abaixo do recomendado (70%)';
              
              const body = `## ğŸ“Š RelatÃ³rio de Cobertura de Testes ${emoji}
              
              | MÃ©trica | Valor |
              |---------|-------|
              | ğŸ¯ **Cobertura de InstruÃ§Ãµes** | **${percentage}%** |
              | ğŸŒ¿ **Cobertura de Branches** | **${branchCoverage}** |
              | âœ… InstruÃ§Ãµes cobertas | ${covered.toLocaleString()} |
              | âŒ InstruÃ§Ãµes nÃ£o cobertas | ${missed.toLocaleString()} |
              | ğŸ“Š Total de instruÃ§Ãµes | ${total.toLocaleString()} |
              
              ### ${status}
              
              ${percentage < 70 ? `
              #### ğŸ’¡ Dicas para melhorar a cobertura:
              - Teste os endpoints da API com \`@WebMvcTest\`
              - Teste a lÃ³gica de negÃ³cio nos services
              - Teste cenÃ¡rios de erro e validaÃ§Ãµes
              - Teste as entidades JPA e relacionamentos
              ` : 'ğŸ‰ Excelente trabalho! Continue assim!'}
              
              ---
              *RelatÃ³rio gerado automaticamente pelo GitHub Actions* ğŸ¤–`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
          } else {
            const body = `## âŒ Erro no RelatÃ³rio de Cobertura
            
            NÃ£o foi possÃ­vel gerar o relatÃ³rio de cobertura de testes.
            
            **PossÃ­veis causas:**
            - Plugin JaCoCo nÃ£o configurado no pom.xml
            - Falha na execuÃ§Ã£o dos testes
            - Erro na geraÃ§Ã£o do relatÃ³rio
            
            Por favor, verifique os logs do workflow para mais detalhes.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          }
          
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.ref_name }}
        path: |
          target/site/jacoco/
          target/surefire-reports/
        retention-days: 30