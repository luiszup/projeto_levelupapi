name: LevelUp API CI/CD
on:
  push:
    branches: [ main, master, infra ]
jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Application
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Grant execute permission for mvnw
      run: chmod +x mvnw
        
    - name: Build with Maven
      run: ./mvnw clean package -DskipTests
      
    - name: Upload JAR as artifact
      uses: actions/upload-artifact@v4
      with:
        name: levelup-jar
        path: target/projeto_levelupapi-0.0.1-SNAPSHOT.jar

  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: Deploy to EC2
    
    steps:
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: levelup-jar
        
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "projeto_levelupapi-0.0.1-SNAPSHOT.jar"
        target: "/home/ec2-user/"
        
    - name: Deploy on EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Stop current application
          echo "ğŸ›‘ Stopping current application..."
          PID=$(ps aux | grep 'projeto_levelupapi-0.0.1-SNAPSHOT.jar' | grep -v grep | awk '{print $2}')
          if [ ! -z "$PID" ]; then
            echo "Killing process PID: $PID"
            kill -9 $PID
            sleep 5
          else
            echo "No application running"
          fi
          
          # Backup previous version
          if [ -f "/home/ec2-user/projeto_levelupapi-0.0.1-SNAPSHOT.jar.current" ]; then
            echo "ğŸ“¦ Backing up previous version..."
            mv /home/ec2-user/projeto_levelupapi-0.0.1-SNAPSHOT.jar.current /home/ec2-user/projeto_levelupapi-0.0.1-SNAPSHOT.jar.backup
          fi
          
          # Move new version to current
          echo "ğŸ“ Installing new version..."
          mv /home/ec2-user/projeto_levelupapi-0.0.1-SNAPSHOT.jar /home/ec2-user/projeto_levelupapi-0.0.1-SNAPSHOT.jar.current
          
          # Start new application
          echo "â–¶ï¸ Starting new application..."
          cd /home/ec2-user
          nohup java -jar -Dspring.profiles.active=prod projeto_levelupapi-0.0.1-SNAPSHOT.jar.current > app.log 2>&1 &
          NEW_PID=$!
          
          echo "âœ… Deployment completed!"
          echo "ğŸ†” New PID: $NEW_PID"
          echo "ğŸŒ URL: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8080/swagger-ui.html"
          
          # Wait and verify
          sleep 15
          if ps -p $NEW_PID > /dev/null; then
            echo "âœ… Application is running successfully!"
          else
            echo "âŒ Application failed to start!"
            echo "ğŸ“„ Last log lines:"
            tail -10 app.log
          fi